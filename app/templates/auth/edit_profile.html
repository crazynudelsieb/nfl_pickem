{% extends "base.html" %}

{% block title %}Edit Profile - NFL Pick'em{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Edit Profile</h1>
        <p class="page-subtitle">Update your account information</p>
    </div>

    <div class="edit-profile-section">
        <div class="form-card">
            <form method="POST" class="profile-form">
                {{ form.hidden_tag() }}
                
                <div class="form-group">
                    {{ form.username.label(class="form-label") }}
                    {{ form.username(class="form-input") }}
                    {% if form.username.errors %}
                        <div class="form-errors">
                            {% for error in form.username.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.email.label(class="form-label") }}
                    {{ form.email(class="form-input") }}
                    {% if form.email.errors %}
                        <div class="form-errors">
                            {% for error in form.email.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-group">
                    {{ form.display_name.label(class="form-label") }}
                    {{ form.display_name(class="form-input") }}
                    <small class="form-help">This is how your name will appear to other users</small>
                    {% if form.display_name.errors %}
                        <div class="form-errors">
                            {% for error in form.display_name.errors %}
                                <span class="form-error">{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <div class="form-actions">
                    {{ form.submit(class="btn btn-primary") }}
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-secondary">Cancel</a>
                </div>
            </form>
        </div>

        <div class="preview-card">
            <h3 class="preview-title">Profile Preview</h3>
            <div class="profile-preview">
                <div class="preview-avatar">
                    {% if current_user.avatar_url %}
                        <img src="{{ current_user.avatar_url }}" alt="{{ current_user.username }}" class="avatar-image" id="preview-avatar">
                    {% else %}
                        <div class="avatar-circle">
                            {{ current_user.username[0]|upper }}
                        </div>
                    {% endif %}
                </div>
                <div class="preview-info">
                    <div class="preview-name" id="preview-display-name">
                        {{ current_user.display_name or current_user.username }}
                    </div>
                    <div class="preview-username" id="preview-username">
                        @{{ current_user.username }}
                    </div>
                    <div class="preview-email" id="preview-email">
                        {{ current_user.email }}
                    </div>
                </div>
            </div>
            
            <div class="avatar-actions">
                <form method="POST" action="{{ url_for('auth.regenerate_avatar') }}" id="regenerate-form">
                    {{ form.hidden_tag() }}
                    <button type="submit" class="btn btn-secondary" id="regenerate-btn">
                        <i class="fas fa-sync-alt"></i> Generate New Picture
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.edit-profile-section {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 2rem;
    margin-top: 2rem;
}

.form-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
}

.profile-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.preview-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 2rem;
    height: fit-content;
}

.preview-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 1.5rem 0;
}

.profile-preview {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.preview-avatar {
    flex-shrink: 0;
}

.avatar-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
}

.avatar-image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
}

.avatar-actions {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
}

.avatar-actions form {
    margin: 0;
}

.avatar-actions .btn {
    width: 100%;
    justify-content: center;
}

#regenerate-btn i {
    transition: transform 0.3s ease;
}

#regenerate-btn:hover i {
    transform: rotate(180deg);
}

#regenerate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.preview-info {
    flex-grow: 1;
}

.preview-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.25rem 0;
}

.preview-username {
    color: var(--text-secondary);
    font-weight: 500;
    margin: 0 0 0.25rem 0;
}

.preview-email {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin: 0;
}

.form-help {
    display: block;
    margin-top: 0.25rem;
    color: var(--text-muted);
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .edit-profile-section {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .profile-preview {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
// Live preview updates
document.addEventListener('DOMContentLoaded', function() {
    const usernameInput = document.getElementById('username');
    const displayNameInput = document.getElementById('display_name');
    const emailInput = document.getElementById('email');
    
    const previewUsername = document.getElementById('preview-username');
    const previewDisplayName = document.getElementById('preview-display-name');
    const previewEmail = document.getElementById('preview-email');
    
    if (usernameInput && previewUsername) {
        usernameInput.addEventListener('input', function() {
            previewUsername.textContent = '@' + this.value;
        });
    }
    
    if (displayNameInput && previewDisplayName) {
        displayNameInput.addEventListener('input', function() {
            const displayName = this.value.trim();
            const username = usernameInput ? usernameInput.value : '{{ current_user.username }}';
            previewDisplayName.textContent = displayName || username;
        });
    }
    
    if (emailInput && previewEmail) {
        emailInput.addEventListener('input', function() {
            previewEmail.textContent = this.value;
        });
    }
    
    // Handle avatar regeneration with AJAX
    const regenerateForm = document.getElementById('regenerate-form');
    const regenerateBtn = document.getElementById('regenerate-btn');
    const previewAvatar = document.getElementById('preview-avatar');
    
    if (regenerateForm && regenerateBtn) {
        regenerateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Disable button and show loading state
            regenerateBtn.disabled = true;
            const icon = regenerateBtn.querySelector('i');
            const originalIconClass = icon.className;
            icon.className = 'fas fa-spinner fa-spin';
            
            // Get CSRF token
            const csrfToken = document.querySelector('input[name="csrf_token"]').value;
            
            // Send AJAX request
            fetch('{{ url_for("auth.regenerate_avatar") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.avatar_url) {
                    // Update avatar image with cache-busting parameter
                    if (previewAvatar) {
                        previewAvatar.src = data.avatar_url + '&t=' + Date.now();
                    }
                    
                    // Show success message
                    showToast('New profile picture generated!', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to generate new picture', 'error');
            })
            .finally(() => {
                // Re-enable button and restore icon
                regenerateBtn.disabled = false;
                icon.className = originalIconClass;
            });
        });
    }
    
    // Toast notification function
    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            background-color: ${type === 'success' ? '#28a745' : '#dc3545'};
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 100);
        
        setTimeout(() => {
            toast.style.transform = 'translateX(400px)';
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
});
</script>
{% endblock %}