{% extends "base.html" %}

{% block content %}
<style>
.audit-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
}

.audit-header {
    margin-bottom: 32px;
}

.audit-header h2 {
    color: var(--text-primary);
    margin-bottom: 8px;
}

.audit-header p {
    color: var(--text-secondary);
    margin-bottom: 16px;
}

.audit-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.audit-button {
    padding: 10px 16px;
    background: var(--accent-blue);
    color: #ffffff !important;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.audit-button i {
    color: #ffffff !important;
}

.audit-button:hover,
.audit-button:focus,
.audit-button:active,
.audit-button:visited {
    color: #ffffff !important;
    background: var(--accent-blue-hover);
    transform: translateY(-1px);
}

.audit-button:hover i,
.audit-button:focus i,
.audit-button:active i,
.audit-button:visited i {
    color: #ffffff !important;
}

.audit-button.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary) !important;
}

.audit-button.secondary:hover {
    background: var(--bg-hover);
}

.audit-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.audit-table {
    width: 100%;
    border-collapse: collapse;
}

.audit-table thead {
    background: rgba(107, 114, 128, 0.1);
}

.audit-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    border-bottom: 1px solid var(--border-color);
}

.audit-table td {
    padding: 16px;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.audit-table tbody tr:hover {
    background: var(--bg-hover);
}

.audit-table tbody tr:last-child td {
    border-bottom: none;
}

.action-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.action-badge.success {
    background: rgba(16, 185, 129, 0.1);
    color: var(--accent-green);
}

.action-badge.warning {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
}

.action-badge.danger {
    background: rgba(239, 68, 68, 0.1);
    color: var(--accent-red);
}

.action-badge.info {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent-blue);
}

.action-badge.secondary {
    background: rgba(107, 114, 128, 0.1);
    color: var(--text-secondary);
}

.details-button {
    padding: 4px 8px;
    background: transparent;
    border: 1px solid var(--accent-blue);
    color: var(--accent-blue);
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.details-button:hover {
    background: rgba(59, 130, 246, 0.1);
}

.details-row {
    background: var(--bg-tertiary) !important;
}

.details-content {
    padding: 16px;
    font-size: 13px;
    color: var(--text-secondary);
}

.details-content ul {
    margin: 8px 0 0 0;
    padding-left: 20px;
}

.empty-state {
    text-align: center;
    padding: 64px 24px;
}

.empty-state i {
    font-size: 48px;
    color: var(--text-muted);
    margin-bottom: 16px;
}

.empty-state h5 {
    color: var(--text-primary);
    margin-bottom: 8px;
}

.empty-state p {
    color: var(--text-secondary);
    margin-bottom: 24px;
}

.pagination-info {
    font-size: 13px;
    color: var(--text-secondary);
}
</style>

<div class="audit-container">
    <div class="audit-header">
        <h2>Audit Log for {{ group.name }}</h2>
        <p>All administrative actions performed in this group are logged here for transparency.</p>
        
        <div class="audit-controls">
            <div style="display: flex; gap: 12px;">
                <a href="{{ url_for('groups.index', group=group.slug) }}" class="audit-button secondary">
                    <i class="fas fa-arrow-left"></i> Back to Group
                </a>
                {% if group.is_user_admin(current_user.id) %}
                    <a href="{{ url_for('groups.admin_picks', group_id=group.id) }}" class="audit-button" style="color: #ffffff !important;">
                        <i class="fas fa-cogs" style="color: #ffffff !important;"></i> Manage Picks
                    </a>
                {% endif %}
            </div>
            
            {% if actions.pages > 1 %}
            <div class="pagination-info">
                Showing {{ actions.per_page * (actions.page - 1) + 1 }} - 
                {{ actions.per_page * (actions.page - 1) + actions.items|length }} 
                of {{ actions.total }} actions
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if actions.items %}
        <div class="audit-card">
            <table class="audit-table">
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Admin</th>
                        <th>Action</th>
                        <th>Target User</th>
                        <th>Description</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for action in actions.items %}
                    <tr>
                        <td>
                            <div style="font-size: 13px;">
                                {{ action.created_at.strftime('%m/%d/%Y') }}<br>
                                <span style="color: var(--text-secondary);">{{ action.created_at.strftime('%I:%M %p') }}</span>
                            </div>
                        </td>
                        <td>
                            <strong>{{ action.admin_user.username if action.admin_user else 'Unknown' }}</strong>
                        </td>
                        <td>
                            {% if action.action_type == 'create_pick' %}
                                <span class="action-badge success">
                                    <i class="fas fa-plus"></i> Create Pick
                                </span>
                            {% elif action.action_type == 'update_pick' %}
                                <span class="action-badge warning">
                                    <i class="fas fa-edit"></i> Update Pick
                                </span>
                            {% elif action.action_type == 'delete_pick' %}
                                <span class="action-badge danger">
                                    <i class="fas fa-trash"></i> Delete Pick
                                </span>
                            {% elif action.action_type == 'promote_member' %}
                                <span class="action-badge info">
                                    <i class="fas fa-arrow-up"></i> Promote
                                </span>
                            {% elif action.action_type == 'demote_member' %}
                                <span class="action-badge secondary">
                                    <i class="fas fa-arrow-down"></i> Demote
                                </span>
                            {% elif action.action_type == 'remove_member' %}
                                <span class="action-badge secondary">
                                    <i class="fas fa-user-minus"></i> Remove
                                </span>
                            {% else %}
                                <span class="action-badge secondary">
                                    {{ action.action_type.replace('_', ' ').title() }}
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if action.target_user %}
                                <strong>{{ action.target_user.username }}</strong>
                            {% else %}
                                <span style="color: var(--text-muted);">-</span>
                            {% endif %}
                        </td>
                        <td>{{ action.action_description }}</td>
                        <td>
                            {% if action.action_metadata %}
                                <button class="details-button" 
                                        onclick="toggleDetails({{ action.id }})"
                                        aria-label="Show details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            {% else %}
                                <span style="color: var(--text-muted);">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if action.action_metadata %}
                    <tr class="details-row" id="details-{{ action.id }}" style="display: none;">
                        <td colspan="6">
                            <div class="details-content">
                                <strong>Additional Details:</strong>
                                <ul>
                                    {% for key, value in action.action_metadata.items() %}
                                        <li><strong>{{ key.replace('_', ' ').title() }}:</strong> {{ value }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="audit-card empty-state">
            <i class="fas fa-clipboard-list"></i>
            <h5>No Admin Actions</h5>
            <p>No administrative actions have been performed in this group yet.</p>
            {% if group.is_user_admin(current_user.id) %}
                <a href="{{ url_for('groups.admin_picks', group_id=group.id) }}" class="audit-button">
                    <i class="fas fa-cogs"></i> Manage Picks
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
function toggleDetails(actionId) {
    const row = document.getElementById('details-' + actionId);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
}
</script>
{% endblock %}